理解TCP

```
TCP是流式数据协议，内容间没有明确的分解标志
发送的字符串在局域网或者公网环境下可能会出现接收端打印不完整的情况

出现乱码的原因：
某次输入的数据不仅包含完整字符串，还包括下一个字符串的部分内容
那么recvBuf数组将填满，printf函数输出时会找\0为结束标志的字符
读取的内存出现越界，就会出现乱码
```

如何解决粘包问题

```
使用TCP通信，不存在包乱序和丢包的问题
但是会出现粘包问题
粘包：即对端收到两个或两个以上的数据包、

解决方案是区分包与包的边界，三种方法
1.固定协议包的长度
2.以指定的字符作为包的结束   比如FTP在命令后加\r\n表示结束
3.包头+包体  包头固定大小  包头式固定大小的 且 包含一个字段说明接下来的包体有多大

大多数网络库，都需要根据协议的格式自己对数据包分界和解析
```

解包和处理

```
针对三种格式的数据包

针对最常用的包头+包体格式的数据处理过程如下
```

![image-20210707200620433](C:\Users\Echo\AppData\Roaming\Typora\typora-user-images\image-20210707200620433.png)

```
注意事项：
1.注意取包头时应该拷贝一份数据包头大小的数据，而不是从缓冲区读出来，
防止包头中的字段得到包体大小后，剩余的数据不够包体的大小
2.通过包头得到包体的大小时，一定对bodyzise的值进行校验
判断是否满足自己设置的上下限
3.整个判断包头/包体/处理包的逻辑都放在一个while循环里.
```

从struct到TLV（Type Length Value）

```
根据应用场景设计合理的网络通信协议

为了应对不断迭代的需求，比如原先的协议只有两个字段，
如果需要重新加新的字段，不能直接在原结构体添加，
所以可以设计一个版本号字段，针对不同的版本进行不同的处理

对于程度不确定的字段，可以在字段倩加一个表示字符串长度的标志，即类型值
这样每个字段就是自解释--即TLV（Type Length Value）
这样可以方便的增删改字段类型
```

![image-20210707203108234](C:\Users\Echo\AppData\Roaming\Typora\typora-user-images\image-20210707203108234.png)

整形数值的压缩

```
整形数值（int 32、int 64 ）在协议字段的出现频率很高
分别表示4字节和八字节  但是实际用不到太长的字段值。。

**实际中以字节的最高位作为标志位
如果一个字节的最高位是为0  表示内容到此结束  为1 表示下一个字节仍是整形值的内容

这样一个八位的字节只能用7位，其长度可能为1-5字节
在实际中很少有字节超过3，所以改压缩比较实用
```

设计通信协议的注意事项

```
字节对齐
pragma pack(push,n)表示每一个字段按照n字节对其，
即去除所有padding字节  使内存更加紧凑

显式指定整型字段的长度
因为不同操作系统上的int/long不一样，（long在32位式4字节，648字节）
所以适用int32_t   和int64_t这样的类型代替int/long
防止出现协议解析错误

浮点数要考虑精度
有的浮点数的业务单位较大（亿），为了避免不同机器得到不同的结果，
在网络传输时将浮点数放大相应倍数，
或者整数转换成字符串传输

大小端字节序
网络字节序是大端编码

协议与自动升级功能
客户端与服务器通信的所有协议格式中，自动升级协议是最重要的
```

包分片

```
应用层对包的拆分
当一个包的数据较大，超过可发送包的最长长度时，需要对包分片。
一般根据需求对包的类型编号（业务号），

设置包分片的两种思路：
1.设置分片标志，包头设置字段表示是否属于某个大包
2.每个包分片的包头都有该包的总分片数量和当前分片编号，
```

XML和JSON格式的协议

```
这两种格式具有良好的自我解释性，在开发中广泛使用
一下分别为XML和JSON格式
```

![image-20210707210527373](C:\Users\Echo\AppData\Roaming\Typora\typora-user-images\image-20210707210527373.png)

![image-20210707210541690](C:\Users\Echo\AppData\Roaming\Typora\typora-user-images\image-20210707210541690.png)

```
XML和JSON格式，单独作为协议时，由于业务数据内容的不同，导致每个包长度不一样
在流式数据中采取个固定结束符的方式分割，
每次解包前都需要遍历一次XML得到特定的包结束符
通常不会作为单独的协议格式，而是作为某个协议的一部分出现
```

自定义协议格式

```

```

